<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BaniDB Shabad → ISO 15919 (Custom Translilator)</title>

  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    label, input, button {
      font-size: 1rem;
    }
    input {
      width: calc(100% - 1rem);
      padding: 0.4rem;
      margin: 0.4rem 0;
      box-sizing: border-box;
    }
    button {
      padding: 0.5rem 0.8rem;
      cursor: pointer;
      font-size: 1rem;
    }
    #output {
      margin-top: 1.5rem;
      padding: 0.8rem;
      background: #f9f9f9;
      border: 1px solid #ddd;
      white-space: pre-wrap;
      line-height: 1.4;
    }
  </style>
</head>
<body>

  <h2>Fetch BaniDB Shabad → ISO 15919</h2>

  <div>
    <label for="shabadId">Shabad ID (numeric):</label>
    <input type="number" id="shabadId" placeholder="145" min="1" />

    <label for="sttmUrl">Or paste SikhItotheMax URL:</label>
    <input type="text" id="sttmUrl"
      placeholder="https://www.sikhitothemax.org/shabad?id=2825" />

    <button id="goBtn">Go</button>
  </div>

  <div id="output">Enter a Shabad ID or URL above and click “Go.”</div>

  <script>
    // ─────────────────────────────────────────────────────────────────────────────
    // ① CUSTOM GURMUKHI→ISO 15919 MAPPINGS (per Wikipedia ISO 15919 table)
    // ─────────────────────────────────────────────────────────────────────────────

    // Independent vowels (U+0A05…U+0A14)
    const independentVowelMap = {
      '\u0A05': 'a',   // ਅ
      '\u0A06': 'ā',   // ਆ
      '\u0A07': 'i',   // ਇ
      '\u0A08': 'ī',   // ਈ
      '\u0A09': 'u',   // ਉ
      '\u0A0A': 'ū',   // ਊ
      '\u0A0F': 'ē',   // ਏ
      '\u0A10': 'ai',  // ਐ
      '\u0A13': 'ō',   // ਓ
      '\u0A14': 'au'   // ਔ
    };

    // Consonants (core Gurmukhi consonants, each with inherent "a")
    const consonantMap = {
      '\u0A15': 'k',   // ਕ
      '\u0A16': 'kh',  // ਖ
      '\u0A17': 'g',   // ਗ
      '\u0A18': 'gh',  // ਘ
      '\u0A19': 'ṅ',   // ਙ
      '\u0A1A': 'c',   // ਚ
      '\u0A1B': 'ch',  // ਛ
      '\u0A1C': 'j',   // ਜ
      '\u0A1D': 'jh',  // ਝ
      '\u0A1E': 'ñ',   // ਞ
      '\u0A1F': 'ṭ',   // ਟ
      '\u0A20': 'ṭh',  // ਠ
      '\u0A21': 'ḍ',   // ਡ
      '\u0A22': 'ḍh',  // ਢ
      '\u0A5C': 'ṛ',   // ੜ
      '\u0A23': 'ṇ',   // ਣ
      '\u0A24': 't',   // ਤ
      '\u0A25': 'th',  // ਥ
      '\u0A26': 'd',   // ਦ
      '\u0A27': 'dh',  // ਧ
      '\u0A28': 'n',   // ਨ
      '\u0A2A': 'p',   // ਪ
      '\u0A2B': 'ph',  // ਫ
      '\u0A2C': 'b',   // ਬ
      '\u0A2D': 'bh',  // ਭ
      '\u0A2E': 'm',   // ਮ
      '\u0A2F': 'y',   // ਯ
      '\u0A30': 'r',   // ਰ
      '\u0A32': 'l',   // ਲ
      '\u0A33': 'ḷ',   // ਲ਼
      '\u0A35': 'v',   // ਵ
      '\u0A36': 'ś',   // ਸ਼
      '\u0A38': 's',   // ਸ
      '\u0A39': 'h'    // ਹ
    };

    // Dependent vowel signs (U+0A3E..U+0A4C)
    const vowelSignMap = {
      '\u0A3E': 'ā',   // ◌ਾ
      '\u0A3F': 'i',   // ◌ਿ
      '\u0A40': 'ī',   // ◌ੀ
      '\u0A41': 'u',   // ◌ੁ
      '\u0A42': 'ū',   // ◌ੂ
      '\u0A47': 'ē',   // ◌ੇ
      '\u0A48': 'ai',  // ◌ੈ
      '\u0A4B': 'ō',   // ◌ੋ
      '\u0A4C': 'au'   // ◌ੌ
    };

    // Diacritics and nukta/virama (candrabindu, tippi, anusvāra, visarga, halant)
    const diacriticMap = {
      '\u0A01': 'm̐',  // chandrabindu ◌ਁ
      '\u0A70': 'ṃ',   // tippi ੰ
      '\u0A02': 'ṁ',   // bindi/anusvāra ◌ਂ
      '\u0A03': 'ḥ',   // visarga ◌ਃ
      '\u0A4D': ''     // virama ◌੍  (remove the inherent 'a')
    };

    // Gurmukhi digits U+0A66..U+0A6F → ASCII 0..9
    const digitMap = {
      '\u0A66': '0',
      '\u0A67': '1',
      '\u0A68': '2',
      '\u0A69': '3',
      '\u0A6A': '4',
      '\u0A6B': '5',
      '\u0A6C': '6',
      '\u0A6D': '7',
      '\u0A6E': '8',
      '\u0A6F': '9'
    };

    // ──────────────────────────────────────────────────────────────────────────
    // ② GURMUKHI → ISO 15919 TRANSLITERATOR FUNCTION
    // ──────────────────────────────────────────────────────────────────────────

    function transliterateGurmukhiToISO(input) {
      const output = [];
      let lastWasConsonant = false;

      for (const ch of input) {
        if (independentVowelMap[ch]) {
          // Independent vowel
          output.push(independentVowelMap[ch]);
          lastWasConsonant = false;

        } else if (consonantMap[ch]) {
          // Consonant → base + inherent 'a'
          output.push(consonantMap[ch] + 'a');
          lastWasConsonant = true;

        } else if (vowelSignMap[ch]) {
          // Dependent vowel sign → attach to previous consonant
          if (lastWasConsonant && output.length > 0) {
            let prev = output.pop();
            if (prev.endsWith('a')) {
              prev = prev.slice(0, -1);
            }
            output.push(prev + vowelSignMap[ch]);
          } else {
            // No consonant to attach → standalone vowel
            output.push(vowelSignMap[ch]);
          }
          lastWasConsonant = false;

        } else if (diacriticMap[ch] !== undefined) {
          // Diacritic or virama
          if (ch === '\u0A4D' && lastWasConsonant && output.length > 0) {
            // Virama → remove trailing 'a'
            let prev = output.pop();
            if (prev.endsWith('a')) {
              prev = prev.slice(0, -1);
            }
            output.push(prev);
          } else {
            // Candrabindu/tippi/anusvāra/visarga
            const dm = diacriticMap[ch];
            if (dm) {
              output.push(dm);
            }
          }
          lastWasConsonant = false;

        } else if (digitMap[ch]) {
          // Gurmukhi digit → ASCII digit
          output.push(digitMap[ch]);
          lastWasConsonant = false;

        } else {
          // Everything else (spaces, punctuation) passes unchanged
          output.push(ch);
          lastWasConsonant = false;
        }
      }

      return output.join('');
    }

    // ──────────────────────────────────────────────────────────────────────────
    // ③ MAIN LOGIC: Fetch JSON, Apply Transliteration, Display
    // ──────────────────────────────────────────────────────────────────────────

    document.getElementById('goBtn').addEventListener('click', () => {
      const shabadInput = document.getElementById('shabadId').value.trim();
      const sttmUrl     = document.getElementById('sttmUrl').value.trim();
      const outputDiv   = document.getElementById('output');
      let idValue = '';

      // 1. If URL field is nonempty, extract “id=####”
      if (sttmUrl) {
        try {
          const parsed = new URL(sttmUrl);
          const qid = parsed.searchParams.get('id');
          if (qid && /^\d+$/.test(qid)) {
            idValue = qid;
          } else {
            throw new Error('No numeric “id” query parameter in URL.');
          }
        } catch (e) {
          outputDiv.textContent = '❌ Error: Invalid URL provided.';
          return;
        }
      }

      // 2. Otherwise, use numeric input
      if (!idValue) {
        if (!shabadInput) {
          outputDiv.textContent = '⚠️ Please enter a numeric Shabad ID or a valid URL.';
          return;
        }
        idValue = shabadInput;
      }

      outputDiv.textContent = '⏳ Fetching Shabad …';

      fetch(`https://api.banidb.com/v2/shabads/${encodeURIComponent(idValue)}`)
        .then(resp => {
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return resp.json();
        })
        .then(json => {
          const versesArr = json.verses;
          if (!Array.isArray(versesArr) || versesArr.length === 0) {
            throw new Error('No verses found for that ID.');
          }

          // 3. For each verse, get verse.unicode (Gurmukhi) and transliterate
          const romanizedLines = versesArr.map(item => {
            const gurmukhiLine = item.verse && item.verse.unicode;
            return transliterateGurmukhiToISO(gurmukhiLine || '');
          });

          outputDiv.textContent = romanizedLines.join('\n');
        })
        .catch(err => {
          console.error(err);
          outputDiv.textContent = '❌ Error: ' + err.message;
        });
    });
  </script>
</body>
</html>
